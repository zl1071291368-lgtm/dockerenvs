<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebShell - Docker 容器终端</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        body {
            background-color: #0b0c10;
            color: #fff;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .terminal-container {
            flex: 1;
            padding: 16px;
        }
        #terminal {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .top-bar {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div>
            <span id="statusDot" class="status-dot status-disconnected"></span>
            <strong id="terminalTitle">WebShell</strong>
            <small class="text-muted" id="containerInfo"></small>
        </div>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light" id="copyCmdBtn">复制连接命令</button>
            <button class="btn btn-success" id="reconnectBtn">重新连接</button>
            <button class="btn btn-secondary" onclick="window.close()">关闭窗口</button>
        </div>
    </div>
    <div class="terminal-container">
        <div id="terminal"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
            theme: {
                background: '#0b0c10',
                foreground: '#c5c6c7',
                cursor: '#66fcf1',
                selectionBackground: 'rgba(102, 252, 241, 0.2)'
            }
        });
        term.open(document.getElementById('terminal'));

        let socket = null;
        const params = new URLSearchParams(window.location.search);
        const containerId = params.get('containerId');
        const containerName = params.get('name') || '';
        const terminalTitle = document.getElementById('terminalTitle');
        const containerInfo = document.getElementById('containerInfo');
        const statusDot = document.getElementById('statusDot');
        const reconnectBtn = document.getElementById('reconnectBtn');
        const copyCmdBtn = document.getElementById('copyCmdBtn');

        if (!containerId) {
            term.writeln('\x1b[31m缺少 containerId 参数，无法建立连接。\x1b[0m');
            throw new Error('missing containerId');
        }

        terminalTitle.textContent = `容器终端 - ${containerName || containerId}`;
        containerInfo.textContent = ` (${containerId})`;

        function connectWebSocket() {
            if (socket) {
                socket.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws/terminal?containerId=${encodeURIComponent(containerId)}`;

            socket = new WebSocket(wsUrl);
            statusDot.classList.remove('status-connected');
            statusDot.classList.add('status-disconnected');
            term.writeln('\x1b[33m正在连接容器，请稍候...\x1b[0m');

            socket.addEventListener('open', () => {
                statusDot.classList.remove('status-disconnected');
                statusDot.classList.add('status-connected');
                term.writeln('\x1b[32m连接成功，可以开始输入命令。\x1b[0m');
            });

            socket.addEventListener('message', (event) => {
                term.write(event.data);
            });

            socket.addEventListener('close', () => {
                statusDot.classList.remove('status-connected');
                statusDot.classList.add('status-disconnected');
                term.writeln('\r\n\x1b[31m连接已关闭，点击「重新连接」尝试再次建立会话。\x1b[0m');
            });

            socket.addEventListener('error', (err) => {
                console.error('WebSocket error', err);
                term.writeln('\r\n\x1b[31mWebSocket 出错，请检查后台服务或网络。\x1b[0m');
            });
        }

        term.onData(data => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(data);
            }
        });

        reconnectBtn.addEventListener('click', () => {
            connectWebSocket();
        });

        copyCmdBtn.addEventListener('click', () => {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws/terminal?containerId=${encodeURIComponent(containerId)}`;
            navigator.clipboard.writeText(wsUrl).then(() => {
                copyCmdBtn.textContent = '已复制';
                setTimeout(() => copyCmdBtn.textContent = '复制连接命令', 1500);
            }).catch(() => {
                copyCmdBtn.textContent = '复制失败';
                setTimeout(() => copyCmdBtn.textContent = '复制连接命令', 1500);
            });
        });

        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.close();
            }
        });

        connectWebSocket();
    </script>
</body>
</html>

