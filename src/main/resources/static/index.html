<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟环境管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .status-running {
            background-color: #28a745;
            color: white;
        }
        .status-stopped {
            background-color: #dc3545;
            color: white;
        }
        .status-created {
            background-color: #ffc107;
            color: #000;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .btn-group-sm .btn {
            padding: 0.125rem 0.5rem;
            font-size: 0.875rem;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card .card-body {
            padding: 1.5rem;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-box-seam"></i> 虚拟环境管理平台
            </a>
            <div class="d-flex gap-2">
                <a href="shared-mysql.html" class="btn btn-light btn-sm">
                    <i class="bi bi-database"></i> 共享数据库
                </a>
                <button class="btn btn-light btn-sm" onclick="refreshEnvs()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 small">总环境数</div>
                                <div class="stats-number" id="totalEnvs">0</div>
                            </div>
                            <i class="bi bi-stack" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 small">运行中</div>
                                <div class="stats-number" id="runningEnvs">0</div>
                            </div>
                            <i class="bi bi-play-circle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 small">已停止</div>
                                <div class="stats-number" id="stoppedEnvs">0</div>
                            </div>
                            <i class="bi bi-stop-circle" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 small">已创建</div>
                                <div class="stats-number" id="createdEnvs">0</div>
                            </div>
                            <i class="bi bi-hourglass-split" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建环境表单 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-plus-circle"></i> 创建新环境
            </div>
            <div class="card-body">
                <form id="createEnvForm" onsubmit="createEnv(event)">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">用户ID</label>
                                <input type="text" class="form-control" id="userId" required placeholder="例如: test1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">系统ID</label>
                                <input type="text" class="form-control" id="systemId" placeholder="例如: system001">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">实验ID</label>
                                <input type="text" class="form-control" id="expId" required placeholder="例如: exp-java-001">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-play-fill"></i> 创建环境
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 环境列表 -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 环境列表</h5>
            </div>
            <div class="card-body p-0">
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载环境列表...</p>
                </div>
                <div id="envTableContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>环境ID</th>
                                    <th>用户ID</th>
                                    <th>系统ID</th>
                                    <th>实验ID</th>
                                    <th>端口</th>
                                    <th>状态</th>
                                    <th>容器ID</th>
                                    <th>访问URL</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="envTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="emptyState" style="display: none;" class="text-center p-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">暂无环境数据</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/env';
        let toast = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            toast = new bootstrap.Toast(document.getElementById('toast'));
            loadEnvs();
            // 每30秒自动刷新
            setInterval(loadEnvs, 30000);
        });

        // 加载环境列表
        async function loadEnvs() {
            try {
                const response = await fetch(`${API_BASE}/all`);
                const result = await response.json();
                
                if (result.success) {
                    renderEnvs(result.data);
                    updateStats(result.data);
                } else {
                    showToast('加载失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('加载失败: ' + error.message, 'danger');
            }
        }

        // 渲染环境列表
        function renderEnvs(envs) {
            const tbody = document.getElementById('envTableBody');
            const loading = document.getElementById('loading');
            const container = document.getElementById('envTableContainer');
            const emptyState = document.getElementById('emptyState');

            loading.style.display = 'none';

            if (envs.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = envs.map(env => {
                const statusClass = getStatusClass(env.status);
                const statusText = getStatusText(env.status);
                const containerId = env.containerId ? env.containerId.substring(0, 12) + '...' : '-';
                
                return `
                    <tr>
                        <td><code>${env.envId}</code></td>
                        <td>${env.userId}</td>
                        <td>${env.systemId || '-'}</td>
                        <td><span class="badge bg-secondary">${env.expId}</span></td>
                        <td><strong>${env.port}</strong></td>
                        <td><span class="badge status-badge ${statusClass}">${statusText}</span></td>
                        <td><small><code>${containerId}</code></small></td>
                        <td>
                            ${env.url ? `<a href="${env.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i> 访问
                            </a>` : '-'}
                        </td>
                        <td><small>${formatDateTime(env.createdTime)}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                ${env.status === 'RUNNING' ? `
                                    <button class="btn btn-outline-warning" onclick="stopEnv('${env.envId}')" title="停止">
                                        <i class="bi bi-stop-fill"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-success" onclick="startEnv('${env.envId}')" title="启动">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                `}
                                ${env.containerId ? `
                                    <button class="btn btn-outline-primary" onclick="openTerminal('${env.containerId}', '${(env.containerName || env.envId).replace(/'/g, "\\'")}')" title="打开终端">
                                        <i class="bi bi-terminal"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline-info" onclick="resetEnv('${env.envId}')" title="重置">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="destroyEnv('${env.envId}')" title="销毁">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新统计信息
        function updateStats(envs) {
            document.getElementById('totalEnvs').textContent = envs.length;
            document.getElementById('runningEnvs').textContent = envs.filter(e => e.status === 'RUNNING').length;
            document.getElementById('stoppedEnvs').textContent = envs.filter(e => e.status === 'STOPPED').length;
            document.getElementById('createdEnvs').textContent = envs.filter(e => e.status === 'CREATED').length;
        }

        // 创建环境
        async function createEnv(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const systemId = document.getElementById('systemId').value;
            const expId = document.getElementById('expId').value;

            try {
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, systemId, expId })
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('环境创建成功！', 'success');
                    document.getElementById('createEnvForm').reset();
                    setTimeout(loadEnvs, 1000);
                } else {
                    showToast('创建失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('创建失败: ' + error.message, 'danger');
            }
        }

        // 停止环境
        async function stopEnv(envId) {
            if (!confirm('确定要停止该环境吗？')) return;
            
            try {
                const response = await fetch(`${API_BASE}/stop?envId=${envId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('环境已停止', 'success');
                    setTimeout(loadEnvs, 1000);
                } else {
                    showToast('停止失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('停止失败: ' + error.message, 'danger');
            }
        }

        // 启动环境（通过重置实现）
        async function startEnv(envId) {
            try {
                const response = await fetch(`${API_BASE}/reset?envId=${envId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('环境已启动', 'success');
                    setTimeout(loadEnvs, 2000);
                } else {
                    showToast('启动失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('启动失败: ' + error.message, 'danger');
            }
        }

        // 重置环境
        async function resetEnv(envId) {
            if (!confirm('确定要重置该环境吗？这将重新部署程序包。')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reset?envId=${envId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('环境重置成功', 'success');
                    setTimeout(loadEnvs, 2000);
                } else {
                    showToast('重置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('重置失败: ' + error.message, 'danger');
            }
        }

        // 销毁环境
        async function destroyEnv(envId) {
            if (!confirm('确定要销毁该环境吗？此操作不可恢复！')) return;
            
            try {
                const response = await fetch(`${API_BASE}/${envId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('环境已销毁', 'success');
                    setTimeout(loadEnvs, 1000);
                } else {
                    showToast('销毁失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showToast('销毁失败: ' + error.message, 'danger');
            }
        }

        // 刷新列表
        function refreshEnvs() {
            loadEnvs();
            showToast('正在刷新...', 'info');
        }

        function openTerminal(containerId, containerName) {
            if (!containerId) {
                showToast('当前环境尚未启动容器，无法打开终端', 'warning');
                return;
            }
            const query = new URLSearchParams({
                containerId,
                name: containerName || ''
            }).toString();
            window.open(`terminal.html?${query}`, '_blank');
        }

        // 工具函数
        function getStatusClass(status) {
            const map = {
                'RUNNING': 'status-running',
                'STOPPED': 'status-stopped',
                'CREATED': 'status-created'
            };
            return map[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const map = {
                'RUNNING': '运行中',
                'STOPPED': '已停止',
                'CREATED': '已创建'
            };
            return map[status] || status;
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN');
        }

        function showToast(message, type = 'info') {
            const toastBody = document.getElementById('toastBody');
            const toastHeader = document.querySelector('#toast .toast-header');
            
            toastBody.textContent = message;
            
            // 设置颜色
            toastHeader.className = 'toast-header';
            if (type === 'success') {
                toastHeader.classList.add('bg-success', 'text-white');
            } else if (type === 'danger') {
                toastHeader.classList.add('bg-danger', 'text-white');
            } else if (type === 'info') {
                toastHeader.classList.add('bg-info', 'text-white');
            }
            
            toast.show();
        }
    </script>
</body>
</html>

